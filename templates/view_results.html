<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{url_for('static', filename='style.css')}}">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/256/12145/12145256.png"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <title>View Results</title>
</head>

<body>


<div class="header">
    <div class="header_text">Система студентов</div>
    <div class="button-container">
        <a href="/main" class="button button-header">Вернуться на главную</a>
    </div>
</div>


<div class="result-container">
    <h3>Здесь вы можете просмотреть информацию о тестах</h3>
    <div class="find-result-container">
        <form action="/view_results" method="post" onsubmit="return validateForm();">
            <h3>Для быстрого поиска ведите тему теста или дату его написания</h3>
            <div class="separator-line"></div>

            <label for="theme">Введите тему:</label>
            <select id="theme" name="theme">
                <option value="">-- Выберите тему --</option>
                {% for t in themes %}
                    <option value="{{ t }}" {% if t == theme %} selected {% endif %}>{{ t }}</option>
                {% endfor %}
            </select>

            <label for="date">Введите дату:</label>
            <div class="result-input-group">
                <input type="text" id="date" name="date" placeholder="YYYY-MM-DD" pattern="\d{4}-\d{2}-\d{2}"
                       title="Введите дату в формате YYYY-MM-DD" min="1900-01-01" max="9999-12-31" value="{{ request.form['date'] if request.form.get('date') else '' }}">
            </div>
        <div class="sumbit_container">
            <input type="submit" value="Поиск">
            <button type="button" class = "base-button" onclick="resetFilters()">Сбросить фильтры</button>
        </div>
        </form>
        <div class="separator-line"></div>
        <div class="sumbit_container">
            <a href="/save_to_word" class="button-none-result">Сохранить отчёт DOCX</a>
        </div>
    </div>


    <div class="view-result-container">
        {% if search_test_results %}
            <h3>Результаты поиска:</h3>
            <ul class="results-list">
                {% for result in search_test_results %}
                <li class="result-block">
                        <strong>Тема:</strong> {{ result[5] }}<br>
                        <strong>Оценка:</strong> {{ result[3] }}<br>
                        <strong>Дата прохождения:</strong> {{ result[2] }}<br>
                        <strong>Средняя оценка:</strong> {{ result[4] }}<br>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <h3>Все результаты:</h3>
            <ul class="resultsList">
                {% for result in test_results %}
                <div class="result-block">
                    <li>
                        <strong>Тема:</strong> {{ result[5] }}<br>
                        <strong>Оценка:</strong> {{ result[3] }}<br>
                        <strong>Дата прохождения:</strong> {{ result[2] }}<br>
                        <strong>Средняя оценка:</strong> {{ result[4] }}<br>
                    </li>
                </div>
                {% endfor %}
            </ul>
        {% endif %}

        {% if not search_test_results and not test_results %}
            <p>Подходящих тестов не найдено.</p>
        {% endif %}
    </div>
</div>

<script>

<!--    отчет по фильтру-->
<!--    валидация-->

    function validateForm() {
    var themeValue = themeSelect.value;
    var dateValue = document.getElementById("date").value.trim();

    if (themeValue.trim() === '' && dateValue === '') {
        showAlert("Пожалуйста, заполните хотя бы одно поле");
        return false;
    }

    try {
        if (dateValue !== '') {
            var date = new Date(dateValue);
            var minDate = new Date('1900-01-01');
            var maxDate = new Date('9999-12-31');

            if (isNaN(date) || date < minDate || date > maxDate) {
                throw "Дата вне разумного диапазона или имеет неверный формат";
            }
        }

        return true;
    } catch (error) {
        showAlert("Предупреждение: " + error);
        return false;
    }
}

function showAlert(message) {
    alert(message);
}


<!--    // Добавление тем из базы данных в выпадающий список-->
<!--    var themesFromDB = {{ themes | tojson | safe }};-->
<!--    var themeSelect = document.getElementById("theme");-->

<!--    for (var i = 0; i < themesFromDB.length; i++) {-->
<!--        var option = document.createElement("option");-->
<!--        option.value = themesFromDB[i];-->
<!--        option.text = themesFromDB[i];-->
<!--        themeSelect.appendChild(option);-->
<!--    }-->

   function saveToWord() {
    var themeSelect = document.getElementById("theme");

    if (themeSelect) {
        var themeValue = themeSelect.value;
        var dateValue = document.getElementById("date").value;

        var url = `/search_save_to_word?theme=${themeValue}&date=${dateValue}`;
        window.location.href = url;
    } else {
        console.error("Элемент с id 'theme' не найден.");
    }
}

function resetFilters() {
    document.getElementById("theme").value = "";
    document.getElementById("date").value = "";
     document.querySelector('form').submit();
}


</script>


</body>


</html>
